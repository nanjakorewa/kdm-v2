{{- /* ======= SEO meta & structured data (enhanced) ======= */ -}}
{{- $title := .Title -}}
{{- $desc  := cond (ne .Description "") .Description (.Summary | plainify | htmlUnescape | truncate 160) -}}
{{- $url   := .Permalink -}}
{{- $img   := (or (index .Params.images 0) (site.Params.ogImage)) | absURL -}}
{{- $site  := site.Title -}}
{{- $lang  := .Lang -}}
{{- $author:= (or .Params.author site.Params.author) -}}
{{- $canonical := $url -}}
{{- with .Params.canonical -}}
  {{- $canonical = . | absURL -}}
{{- end -}}
{{- $gaMeasurementId := "" -}}
{{- with site.Params.analytics }}
  {{- with .googleMeasurementId }}
    {{- $gaMeasurementId = . -}}
  {{- end -}}
{{- end -}}

<script>
  (function () {
    if (typeof window === "undefined") {
      return;
    }
    var path = window.location && window.location.pathname ? window.location.pathname : "";
    if (!path) {
      return;
    }
    var search = window.location.search || "";
    var hash = window.location.hash || "";
    if (path === "/ja" || path === "/ja/") {
      window.location.replace("/" + search + hash);
      return;
    }
    if (path.indexOf("/ja/") === 0) {
      var target = path.slice(3);
      if (target.charAt(0) !== "/") {
        target = "/" + target;
      }
      window.location.replace(target + search + hash);
    }
  })();
</script>
{{- if and (eq $gaMeasurementId "") site.GoogleAnalytics -}}
  {{- $gaMeasurementId = site.GoogleAnalytics -}}
{{- end -}}
{{- if and $gaMeasurementId hugo.IsProduction -}}
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id={{ $gaMeasurementId }}"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', '{{ $gaMeasurementId }}');
</script>
{{- end -}}

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="canonical" href="{{ $canonical }}">

{{/* Robots（ドラフト/明示noindexは除外）。高度ロボッツも付与 */}}
{{- $isNoindex := or .Draft .Params.noindex (eq .Params.robots "noindex") -}}
{{- $robotsBase := cond $isNoindex "noindex, nofollow" "index, follow" -}}
{{- $robotsAdv  := "max-snippet:-1, max-image-preview:large, max-video-preview:-1" -}}
<meta name="robots" content="{{ $robotsBase }}, {{ $robotsAdv }}">
<meta name="googlebot" content="{{ $robotsBase }}, {{ $robotsAdv }}">

{{- with site.Params.googleSiteVerification -}}
<meta name="google-site-verification" content="{{ . }}">
{{- end -}}
{{- with site.Params.bingSiteVerification -}}
<meta name="msvalidate.01" content="{{ . }}">
{{- end -}}

<meta name="description" content="{{ $desc }}">
{{ with $author }}<meta name="author" content="{{ . }}">{{ end }}

<!-- Open Graph -->
<meta property="og:title" content="{{ $title }}">
<meta property="og:description" content="{{ $desc }}">
<meta property="og:type" content="{{ if .IsPage }}article{{ else }}website{{ end }}">
<meta property="og:url" content="{{ $url }}">
{{ with $img }}<meta property="og:image" content="{{ . }}">{{ end }}
<meta property="og:site_name" content="{{ $site }}">
<meta property="og:locale" content="{{ $lang }}">
{{- range .AllTranslations -}}
<meta property="og:locale:alternate" content="{{ .Lang }}">
{{- end -}}
{{ with $img }}<meta property="og:image:alt" content="{{ $title }}">{{ end }}
{{ if .IsPage }}
  <meta property="article:published_time" content="{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}">
  <meta property="article:modified_time"  content="{{ .Lastmod.Format "2006-01-02T15:04:05Z07:00" }}">
  <meta property="og:updated_time"        content="{{ .Lastmod.Format "2006-01-02T15:04:05Z07:00" }}">
  {{ with .Section }}<meta property="article:section" content="{{ . }}">{{ end }}
  {{ with .Params.tags }}{{ range . }}<meta property="article:tag" content="{{ . }}">{{ end }}{{ end }}
{{ end }}

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ $title }}">
<meta name="twitter:description" content="{{ $desc }}">
{{ with $img }}<meta name="twitter:image" content="{{ . }}">{{ end }}
{{ with site.Params.twitterSite }}<meta name="twitter:site" content="@{{ . }}">{{ end }}
{{ with (or .Params.twitterCreator site.Params.twitterCreator) }}<meta name="twitter:creator" content="@{{ . }}">{{ end }}

<!-- パフォーマンス微調整（よく使う外部に先行接続） -->
<link rel="preconnect" href="https://www.youtube-nocookie.com" crossorigin>
<link rel="preconnect" href="https://i.ytimg.com" crossorigin>

{{/* ---- KaTeX (site-wide) ---- */}}
{{- $kconf := (resources.Get "katex.json" | transform.Unmarshal) | default (dict
  "delimiters" (slice
    (dict "left" "$$" "right" "$$" "display" true)
    (dict "left" "$"  "right" "$"  "display" false)
    (dict "left" "\\(" "right" "\\)" "display" false)
    (dict "left" "\\[" "right" "\\]" "display" true)
  )
  "throwOnError" false
) -}}

<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer">

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"></script>

<script>
  // 二重初期化を防止
  window.__katexAllPages__ = true;
  document.addEventListener('DOMContentLoaded', function () {
    if (window.renderMathInElement) {
      try {
        renderMathInElement(document.body, {{ $kconf | jsonify }});
      } catch(e) { console && console.warn('KaTeX render skipped:', e); }
    }
  });
</script>
