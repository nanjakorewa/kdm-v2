{{- $url := .Permalink -}}
{{- $title := .Title -}}
{{- $via := site.Params.twitterSite | default "" -}}
{{- $viaParam := "" -}}{{ if $via }}{{ $viaParam = printf "&via=%s" (urlquery $via) }}{{ end }}
{{- $isJa := eq .Lang "ja" -}}
{{- $labelShare := cond $isJa "このページをシェア" "Share this page" -}}
{{- $labelCopy := cond $isJa "URLをコピー" "Copy link" -}}
{{- $labelCopied := cond $isJa "リンクをコピーしました" "Link copied!" -}}
{{- $labelX := cond $isJa "Xに投稿" "Share to X" -}}
{{- $labelFacebook := cond $isJa "Facebookに投稿" "Share to Facebook" -}}
{{- $labelNative := cond $isJa "他のアプリでシェア" "Share via another app" -}}

<nav class="share share--floating" aria-label="{{ $labelShare }}">
  <a class="share__btn share__btn--x"
     href="https://twitter.com/intent/tweet?url={{ $url | urlquery }}&text={{ $title | urlquery }}{{ $viaParam }}"
     target="_blank" rel="noopener"
     aria-label="{{ $labelX }}">
    <span class="sr-only">{{ $labelX }}</span>
    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
      <path d="M4 4h4.5l3.7 5.8L16.8 4H20l-6.4 8.7L20 20h-4.5l-4-6.1L7.2 20H4l6.6-8.9z" fill="currentColor"/>
    </svg>
  </a>

  <a class="share__btn share__btn--facebook"
     href="https://www.facebook.com/sharer/sharer.php?u={{ $url | urlquery }}"
     target="_blank" rel="noopener"
     aria-label="{{ $labelFacebook }}">
    <span class="sr-only">{{ $labelFacebook }}</span>
    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
      <path d="M14.5 8.5V6.4c0-.8.5-1.3 1.5-1.3h1.3V1.8C16.8 1.6 15.7 1.5 14.6 1.5c-2.6 0-4.4 1.6-4.4 4.6v2.4H7v4h3.2V22h4.3v-9.5H17l.4-4h-3z" fill="currentColor"/>
    </svg>
  </a>

  <button class="share__btn share__btn--copy"
          type="button"
          data-url="{{ $url }}"
          data-label="{{ $labelCopy }}"
          data-copied="{{ $labelCopied }}"
          aria-live="polite"
          aria-label="{{ $labelCopy }}">
    <span class="sr-only">{{ $labelCopy }}</span>
    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
      <path d="M8 3.5A2.5 2.5 0 0 1 10.5 1h8A2.5 2.5 0 0 1 21 3.5v8A2.5 2.5 0 0 1 18.5 14h-8A2.5 2.5 0 0 1 8 11.5v-8z" fill="currentColor" opacity=".65"/>
      <path d="M5.5 8H7v7.5A3.5 3.5 0 0 0 10.5 19H17v1.5A3.5 3.5 0 0 1 13.5 24h-8A3.5 3.5 0 0 1 2 20.5v-8A3.5 3.5 0 0 1 5.5 8z" fill="currentColor"/>
    </svg>
  </button>

  <button class="share__btn share__btn--native"
          type="button"
          data-url="{{ $url }}"
          data-title="{{ $title }}"
          aria-label="{{ $labelNative }}">
    <span class="sr-only">{{ $labelNative }}</span>
    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
      <path d="M12 3.5 16.5 8H13v8h-2V8H7.5L12 3.5z" fill="currentColor"/>
      <path d="M5 11h2v7h10v-7h2v8.5A2.5 2.5 0 0 1 16.5 24h-9A2.5 2.5 0 0 1 5 19.5V11z" fill="currentColor"/>
    </svg>
  </button>
</nav>

<script>
(function(){
  const nav = document.currentScript?.previousElementSibling ?? document.querySelector('.share--floating');
  if (!nav) return;

  const copyBtn = nav.querySelector('.share__btn--copy');
  if (copyBtn) {
    copyBtn.addEventListener('click', async function(){
      const targetUrl = this.getAttribute('data-url') || location.href;
      const defaultLabel = this.getAttribute('data-label') || this.getAttribute('aria-label') || '';
      const copiedLabel = this.getAttribute('data-copied') || '{{ $labelCopied }}';
      try{
        await navigator.clipboard.writeText(targetUrl);
      }catch(e){
        const textarea = document.createElement('textarea');
        textarea.value = targetUrl;
        textarea.setAttribute('readonly','');
        textarea.style.position = 'absolute';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        textarea.select();
        try{ document.execCommand('copy'); }catch(_){}
        document.body.removeChild(textarea);
      }
      this.classList.add('share__btn--copied');
      this.setAttribute('aria-label', copiedLabel);
      setTimeout(()=>{
        this.classList.remove('share__btn--copied');
        this.setAttribute('aria-label', defaultLabel);
      }, 1600);
    }, {passive:true});
  }

  const nativeBtn = nav.querySelector('.share__btn--native');
  if (nativeBtn) {
    if (navigator.share) {
      nativeBtn.addEventListener('click', async function(){
        try{
          await navigator.share({
            url: this.getAttribute('data-url') || location.href,
            title: this.getAttribute('data-title') || document.title
          });
        }catch(e){
          // User cancelled share or sharing not available.
        }
      }, {passive:true});
    } else {
      nativeBtn.addEventListener('click', function(){
        const url = this.getAttribute('data-url') || location.href;
        const title = this.getAttribute('data-title') || document.title;
        const mailto = 'mailto:?subject=' + encodeURIComponent(title) + '&body=' + encodeURIComponent(title + '\\n' + url);
        window.open(mailto, '_blank', 'noopener');
      }, {passive:true});
    }
  }
})();
</script>
