{{- $url := .Permalink -}}
{{- $title := .Title -}}
{{- $via := site.Params.twitterSite | default "" -}}
{{- $viaParam := "" -}}{{ if $via }}{{ $viaParam = printf "&via=%s" (urlquery $via) }}{{ end }}
{{- $isJa := eq .Lang "ja" -}}
{{- $labelShare := cond $isJa "このページをシェア" "Share this page" -}}
{{- $labelCopy := cond $isJa "URLをコピー" "Copy link" -}}
{{- $labelCopied := cond $isJa "リンクをコピーしました" "Link copied!" -}}
{{- $labelX := cond $isJa "Xに投稿" "Share to X" -}}
{{- $labelFacebook := cond $isJa "Facebookに投稿" "Share to Facebook" -}}
{{- $labelNative := cond $isJa "他のアプリでシェア" "Share via another app" -}}

<nav class="share share--floating" aria-label="{{ $labelShare }}">
  <a class="share__btn share__btn--x"
     href="https://twitter.com/intent/tweet?url={{ $url | urlquery }}&text={{ $title | urlquery }}{{ $viaParam }}"
     target="_blank" rel="noopener"
     aria-label="{{ $labelX }}">
    <span class="sr-only">{{ $labelX }}</span>
    <i class="fa-brands fa-x-twitter" aria-hidden="true"></i>
  </a>

  <a class="share__btn share__btn--facebook"
     href="https://www.facebook.com/sharer/sharer.php?u={{ $url | urlquery }}"
     target="_blank" rel="noopener"
     aria-label="{{ $labelFacebook }}">
    <span class="sr-only">{{ $labelFacebook }}</span>
    <i class="fa-brands fa-facebook-f" aria-hidden="true"></i>
  </a>

  <button class="share__btn share__btn--copy"
          type="button"
          data-url="{{ $url }}"
          data-label="{{ $labelCopy }}"
          data-copied="{{ $labelCopied }}"
          aria-live="polite"
          aria-label="{{ $labelCopy }}">
    <span class="sr-only">{{ $labelCopy }}</span>
    <i class="fa-solid fa-link" aria-hidden="true"></i>
  </button>

  <button class="share__btn share__btn--native"
          type="button"
          data-url="{{ $url }}"
          data-title="{{ $title }}"
          aria-label="{{ $labelNative }}">
    <span class="sr-only">{{ $labelNative }}</span>
    <i class="fa-solid fa-share-nodes" aria-hidden="true"></i>
  </button>
</nav>

<script>
(function(){
  const scriptEl = document.currentScript;
  const nav = scriptEl?.previousElementSibling ?? document.querySelector('.share--floating');
  if (!nav) return;

  const originalParent = scriptEl?.parentElement ?? nav.parentElement;
  const mq = window.matchMedia('(max-width: 62rem)');
  const findToc = () => document.querySelector('.book-toc-content');

  const placeNav = () => {
    const tocContainer = findToc();
    const useToc = !!tocContainer && !mq.matches;
    if (useToc) {
      if (tocContainer && !tocContainer.contains(nav)) {
        tocContainer.appendChild(nav);
      }
      nav.classList.add('share--in-toc');
    } else if (originalParent && originalParent !== nav.parentElement) {
      const referenceNode = scriptEl ?? originalParent.firstChild;
      originalParent.insertBefore(nav, referenceNode);
      nav.classList.remove('share--in-toc');
    } else {
      nav.classList.remove('share--in-toc');
    }
  };

  if (typeof mq.addEventListener === 'function') {
    mq.addEventListener('change', placeNav);
  } else if (typeof mq.addListener === 'function') {
    mq.addListener(placeNav);
  } else {
    window.addEventListener('resize', placeNav);
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', placeNav, {once:true});
  }
  window.setTimeout(placeNav, 0);
  placeNav();

  const copyBtn = nav.querySelector('.share__btn--copy');
  if (copyBtn) {
    copyBtn.addEventListener('click', async function(){
      const targetUrl = this.getAttribute('data-url') || location.href;
      const defaultLabel = this.getAttribute('data-label') || this.getAttribute('aria-label') || '';
      const copiedLabel = this.getAttribute('data-copied') || '{{ $labelCopied }}';
      try{
        await navigator.clipboard.writeText(targetUrl);
      }catch(e){
        const textarea = document.createElement('textarea');
        textarea.value = targetUrl;
        textarea.setAttribute('readonly','');
        textarea.style.position = 'absolute';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        textarea.select();
        try{ document.execCommand('copy'); }catch(_){}
        document.body.removeChild(textarea);
      }
      this.classList.add('share__btn--copied');
      this.setAttribute('aria-label', copiedLabel);
      setTimeout(()=>{
        this.classList.remove('share__btn--copied');
        this.setAttribute('aria-label', defaultLabel);
      }, 1600);
    }, {passive:true});
  }

  const nativeBtn = nav.querySelector('.share__btn--native');
  if (nativeBtn) {
    if (navigator.share) {
      nativeBtn.addEventListener('click', async function(){
        try{
          await navigator.share({
            url: this.getAttribute('data-url') || location.href,
            title: this.getAttribute('data-title') || document.title
          });
        }catch(e){
          // User cancelled share or sharing not available.
        }
      }, {passive:true});
    } else {
      nativeBtn.addEventListener('click', function(){
        const url = this.getAttribute('data-url') || location.href;
        const title = this.getAttribute('data-title') || document.title;
        const mailto = 'mailto:?subject=' + encodeURIComponent(title) + '&body=' + encodeURIComponent(title + '\\n' + url);
        window.open(mailto, '_blank', 'noopener');
      }, {passive:true});
    }
  }
})();
</script>
